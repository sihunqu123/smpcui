<div class="wechat-config" *ngIf="config">

  <div class="isEnable-radio">
    <!--
      can only enble smpconfig when it has been saved to DB.
    -->
  </div>

  <form [formGroup]="formData" class="config-form">
    <mat-slide-toggle labelPosition="before" formControlName="isShare">
      是否启用
    </mat-slide-toggle>

    <mat-expansion-panel>
      <mat-expansion-panel-header>
        <mat-panel-title>
          微信群密钥
        </mat-panel-title>
        <mat-panel-description>
          {{ tmpData?.appConfig?.configName || '未设置' }}
          <mat-icon>https</mat-icon>
        </mat-panel-description>
      </mat-expansion-panel-header>
      <div class="at-select-parent"
        >
        <app-appconfig-list
          (appconfigSelect)="onAppconfigSelect($event)"
          [isSingleSelect]="true"
          limitSMPTypeTo="WeCom"
          [isOrphan]=true
        ></app-appconfig-list>
      </div>
    </mat-expansion-panel>

    <form [formGroup]="formMap" class="map-form">
      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title>
            内容映射关系
          </mat-panel-title>
          <mat-panel-description>
            映射域到发布内容的正文里
            <mat-icon>settings_ethernet</mat-icon>
          </mat-panel-description>
        </mat-expansion-panel-header>
        <mat-tab-group>
          <mat-tab>
            <ng-template mat-tab-label>
              <mat-icon class="example-tab-icon">edit</mat-icon>
              编辑映射
            </ng-template>
            <div class="map-parent"
                 >
                 <mat-form-field appearance="fill" class="map-AT-title" hideRequiredMarker="false">
                   <mat-label>映射模板的域到社交媒体的标题:</mat-label>
                   <mat-select formControlName="title" required>
                     <mat-option>-- None --</mat-option>
                     <mat-optgroup *ngFor="let group of currentATFields" [label]="group.name" [disabled]="group.disabled">
                       <mat-option *ngFor="let item of group.items" [value]="item.value" [disabled]="item.type !== 'text' && item.type !== 'TextComponent' && item.type !== 'ShortTextComponent'">
                         {{item.viewValue}}
                       </mat-option>
                     </mat-optgroup>
                   </mat-select>
                 </mat-form-field>

                 <mat-form-field appearance="fill" class="map-AT-title" hideRequiredMarker="false">
                   <mat-label>映射模板的域到社交媒体的原文链接:</mat-label>
                   <mat-select formControlName="referFromLink">
                     <mat-option>-- None --</mat-option>
                     <mat-optgroup *ngFor="let group of currentATFields" [label]="group.name" [disabled]="group.disabled">
                       <mat-option *ngFor="let item of group.items" [value]="item.value" [disabled]="item.type !== 'LinkComponent'">
                         {{item.viewValue}}
                       </mat-option>
                     </mat-optgroup>
                   </mat-select>
                 </mat-form-field>

                 <mat-form-field appearance="fill" class="map-AT-title" hideRequiredMarker="false">
                   <mat-label>映射模板的域到社交媒体的封面图片:</mat-label>
                   <mat-select formControlName="cover">
                     <mat-option>-- None --</mat-option>
                     <mat-optgroup *ngFor="let group of currentATFields" [label]="group.name" [disabled]="group.disabled">
                       <mat-option *ngFor="let item of group.items" [value]="item.value" [disabled]="item.type !== 'ImageComponent'">
                         {{item.viewValue}}
                       </mat-option>
                     </mat-optgroup>
                   </mat-select>
                 </mat-form-field>

                 <mat-form-field appearance="fill" class="map-AT-title" hideRequiredMarker="false">
                   <mat-label>映射模板的域到社交媒体的摘要:</mat-label>
                   <mat-select formControlName="summary">
                     <mat-option>-- None --</mat-option>
                     <mat-optgroup *ngFor="let group of currentATFields" [label]="group.name" [disabled]="group.disabled">
                       <mat-option *ngFor="let item of group.items" [value]="item.value" [disabled]="item.type !== 'text' && item.type !== 'TextComponent' && item.type !== 'ShortTextComponent'">
                         {{item.viewValue}}
                       </mat-option>
                     </mat-optgroup>
                   </mat-select>
                 </mat-form-field>



                 <mat-expansion-panel>
                   <mat-expansion-panel-header>
                     <mat-panel-title>
                       文章内容域
                     </mat-panel-title>
                     <mat-panel-description>
                       {{ formMap.value.body?.length || 0 }} 个元素组成
                       <mat-icon>https</mat-icon>
                     </mat-panel-description>
                   </mat-expansion-panel-header>
                   <div class="body-parent"
                        >
                        <table mat-table [dataSource]="dataSourceBody" >
                          <ng-container matColumnDef="field">
                            <th mat-header-cell *matHeaderCellDef > 域 </th>
                            <td mat-cell *matCellDef="let element" title="{{element}}"> {{ translateElement(element) }} </td>
                            <td mat-footer-cell *matFooterCellDef>
                              <mat-form-field appearance="fill" class="map-AT-title" hideRequiredMarker="false">
                                <mat-label>添加一个域</mat-label>
                                <mat-select [(ngModel)]="tmpData.fieldsToAdd" [ngModelOptions]="{standalone: true}" multiple >
                                  <mat-optgroup *ngFor="let group of currentATFields" [label]="group.name" [disabled]="group.disabled">
                                    <mat-option *ngFor="let item of group.items" [value]="item.value" [disabled]="
                                                        !isCanAdd(item)
                                                        ">
                                      {{item.viewValue}}
                                    </mat-option>
                                  </mat-optgroup>
                                </mat-select>
                              </mat-form-field>
                            </td>
                          </ng-container>

                          <ng-container matColumnDef="action">
                            <th mat-header-cell *matHeaderCellDef >
                              操作
                            </th>
                              <td mat-cell *matCellDef="let element" title="操作" >
                                <div class="move-actions">

                                  <button mat-mini-fab mat-raised-button color="basic" aria-label="move top" (click)="moveBody(element, 'top')" >
                                    <mat-icon >publish</mat-icon>
                                  </button>
                                    <button mat-mini-fab mat-raised-button color="basic" aria-label="move up" (click)="moveBody(element, 'up')" class="move-up">
                                      <mat-icon >arrow_drop_up</mat-icon>
                                    </button>
                                <button mat-mini-fab mat-raised-button color="basic" aria-label="move down" (click)="moveBody(element, 'down')" class="move-down">
                                  <mat-icon >arrow_drop_down</mat-icon>
                                </button>
                                <button mat-mini-fab mat-raised-button color="basic" aria-label="move bottom" (click)="moveBody(element, 'bottom')" >
                                  <mat-icon >file_download</mat-icon>
                                </button>

                                  <button mat-mini-fab mat-raised-button color="basic" aria-label="delete" (click)="moveBody(element, 'delete')" >
                                    <mat-icon >delete</mat-icon>
                                  </button>

                                </div>
                              </td>
                              <td mat-footer-cell *matFooterCellDef>
                                <button mat-mini-fab mat-raised-button color="basic" aria-label="move top"
                                                                                     (click)="moveBody(tmpData.fieldsToAdd, 'add')" [disabled]="!tmpData.fieldsToAdd" >
                                                                                     <mat-icon >add</mat-icon>
                                </button>
                              </td>
                          </ng-container>

                          <tr mat-header-row *matHeaderRowDef="displayedColumnsBody"></tr>
                          <tr mat-row
                              *matRowDef="let row; columns: displayedColumnsBody;"
                              ></tr>
                          <tr mat-footer-row *matFooterRowDef="displayedColumnsBody"></tr>
                        </table>
                   </div>
                 </mat-expansion-panel>


            </div>
          </mat-tab>
          <mat-tab *ngIf="onSubmit">
            <ng-template mat-tab-label>
              <mat-icon class="example-tab-icon">remove_red_eye</mat-icon>
              预览
            </ng-template>
            <div class="preview-tab-content">
                <!--
                  TODO: add new dedicated component for preview while editing
                -->
                <div class="preview-content-select" *ngIf="!previewItems">
                  <content-select
                    [atId]="atId"
                    [excludedItems]="[]"
                    (addEvent)="printEnv()"
                    (previewEvent)="previewContents($event)"
                    >
                  </content-select>
                </div>
                <div class="preview-atconfig" *ngIf="previewItems">

                  <div class="config-preview-actions action-group">
                    <button mat-raised-button color="link" (click)="previewItems = null">重新选择文章</button>
                    <button mat-raised-button color="primary" (click)="refershPreview()">刷新预览</button>
                  </div>
                  <preview-wechat
                    [previewItems]="previewItems"
                    [shareConfig]="formData.value"
                    [(previewOption)]="previewOption"
                    *ngIf="previewItems"
                    >
                  </preview-wechat>
                </div>
            </div>
          </mat-tab>
        </mat-tab-group>
      </mat-expansion-panel>
    </form>


  </form>

  <div class="wechat-config-actions action-group">
    <button mat-raised-button color="primary" (click)="save()" [disabled]="!onSubmit">保存</button>
    <button mat-button (click)="printEnv()" *ngIf="isDebug">test</button>
  </div>
</div>
